<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bus Timing Predictor - Flask</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Plotly for Client-side Visualization -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e3f0 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .metric-box {
            background: #f0f4f8;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        input[type="file"], select {
            border: 1px solid #e2e8f0;
            padding: 8px;
            border-radius: 6px;
        }
        .btn-primary {
            background-color: #6366f1;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4f46e5;
        }
        /* Custom modal styles for non-alert messages */
        .custom-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 90%;
            text-align: center;
            display: none;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
    </style>
</head>
<body class="p-4">

    <!-- Custom Modal Backdrop and Modal (Replaces alert/confirm) -->
    <div id="modalBackdrop" class="modal-backdrop"></div>
    <div id="customModal" class="custom-modal">
        <p id="modalMessage" class="text-gray-700 text-lg mb-4"></p>
        <button id="modalCloseBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Close</button>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="text-center py-6">
            <h1 class="text-4xl font-bold text-gray-800">Bus Arrival Time Predictor</h1>
            <p class="text-gray-500 mt-2">Upload data, train the model, and predict bus arrival times using 4 features.</p>
        </header>

        <!-- Main Grid -->
        <div class="grid md:grid-cols-3 gap-6">

            <!-- 1. Upload Section -->
            <div class="card md:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">1. Upload Data</h2>
                <form id="uploadForm" class="space-y-4">
                    <div>
                        <label for="csvFile" class="block text-sm font-medium text-gray-600 mb-1">Select CSV File</label>
                        <input type="file" id="csvFile" accept=".csv" required class="w-full">
                    </div>
                    <button type="submit" id="uploadBtn" class="btn-primary w-full">
                        <span id="uploadText">Upload Data</span>
                        <div id="uploadSpinner" class="hidden inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div>
                    </button>
                    <div id="uploadStatus" class="mt-2 text-sm text-green-600 hidden"></div>
                </form>
            </div>

            <!-- 2. Training Section -->
            <div class="card md:col-span-1" id="trainCard">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">2. Configure & Train</h2>
                <form id="trainForm" class="space-y-4">
                    <div>
                        <label for="modelType" class="block text-sm font-medium text-gray-600 mb-1">Model Type</label>
                        <select id="modelType" class="w-full border border-gray-300 p-2 rounded-lg">
                            <option value="linear">Linear Regression</option>
                            <option value="poly">Polynomial Regression (Degree 2)</option>
                        </select>
                    </div>
                    <div>
                        <label for="trainSplit" class="block text-sm font-medium text-gray-600 mb-1">Train Split (%)</label>
                        <input type="number" id="trainSplit" value="80" min="50" max="95" required class="w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    <button type="submit" id="trainBtn" class="btn-primary w-full bg-indigo-500 hover:bg-indigo-600">
                        <span id="trainText">Start Training</span>
                        <div id="trainSpinner" class="hidden inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div>
                    </button>
                </form>

                <div id="metricsArea" class="mt-6 hidden">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Metrics (Test Set)</h3>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="metric-box">
                            <p class="text-xs font-medium text-gray-500">MAE</p>
                            <p id="metricMAE" class="text-lg font-bold text-indigo-600">-</p>
                        </div>
                        <div class="metric-box">
                            <p class="text-xs font-medium text-gray-500">RMSE</p>
                            <p id="metricRMSE" class="text-lg font-bold text-indigo-600">-</p>
                        </div>
                        <div class="metric-box">
                            <p class="text-xs font-medium text-gray-500">RÂ² Score</p>
                            <p id="metricR2" class="text-lg font-bold text-indigo-600">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Prediction Section -->
            <div class="card md:col-span-1">
                <h2 class="text-2xl font-semibold mb-4 text-gray-700">3. Real-Time Prediction</h2>
                <form id="predictForm" class="space-y-4">
                    <!-- Hour -->
                    <div>
                        <label for="inputHour" class="block text-sm font-medium text-gray-600 mb-1">Current Hour (0-23)</label>
                        <input type="number" id="inputHour" placeholder="e.g., 14" min="0" max="23" required class="w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    <!-- Weekday -->
                    <div>
                        <label for="inputWeekday" class="block text-sm font-medium text-gray-600 mb-1">Weekday (0=Mon, 6=Sun)</label>
                        <input type="number" id="inputWeekday" placeholder="e.g., 3" min="0" max="6" required class="w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    <!-- Scheduled Arrival Time -->
                    <div>
                        <label for="inputScheduled" class="block text-sm font-medium text-gray-600 mb-1">Scheduled Arrival (minutes)</label>
                        <input type="number" id="inputScheduled" placeholder="e.g., 60" min="0" required class="w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    <!-- Passenger Count (NEW FEATURE) -->
                    <div>
                        <label for="inputPassengerCount" class="block text-sm font-medium text-gray-600 mb-1">Current Passenger Count</label>
                        <input type="number" id="inputPassengerCount" placeholder="e.g., 15" min="0" required class="w-full border border-gray-300 p-2 rounded-lg">
                    </div>
                    
                    <button type="submit" id="predictBtn" class="btn-primary w-full bg-blue-500 hover:bg-blue-600">
                        <span id="predictText">Get Prediction</span>
                        <div id="predictSpinner" class="hidden inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-current border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status"></div>
                    </button>
                </form>

                <div id="predictionResult" class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 hidden rounded-lg">
                    <!-- Prediction output goes here -->
                </div>
            </div>
        </div>

        <!-- Plotting & Download Section -->
        <div class="card mt-6 md:col-span-3">
            <h2 class="text-2xl font-semibold mb-4 text-gray-700">4. Visualization & Download</h2>
            <div id="plotArea" class="h-96 w-full bg-gray-50 border border-gray-300 rounded-lg flex items-center justify-center">
                <p id="plotPlaceholder" class="text-gray-500 p-4">Train the model to view the Actual vs. Predicted scatter plot.</p>
            </div>
            <button id="downloadBtn" class="btn-primary w-full mt-4 bg-green-500 hover:bg-green-600">Download Test Results CSV</button>
        </div>
    </div>

    <script>
        // --- Custom Modal Functions (Replacing alert) ---
        const modal = document.getElementById('customModal');
        const modalBackdrop = document.getElementById('modalBackdrop');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseBtn = document.getElementById('modalCloseBtn');
        
        modalCloseBtn.onclick = () => { 
            modal.style.display = 'none'; 
            modalBackdrop.style.display = 'none';
        };
        
        function showMessage(message) {
            modalMessage.textContent = message;
            modal.style.display = 'block';
            modalBackdrop.style.display = 'block';
        }

        // --- Plotly Visualization ---
        function plotResults(actual, predicted) {
            document.getElementById('plotPlaceholder').classList.add('hidden');

            const actualTrace = {
                x: actual,
                y: predicted,
                mode: 'markers',
                type: 'scatter',
                name: 'Prediction',
                marker: { color: '#6366f1', size: 8, opacity: 0.6 }
            };

            const idealTrace = {
                x: actual,
                y: actual,
                mode: 'lines',
                type: 'scatter',
                name: 'Ideal (Actual = Predicted)',
                line: { color: 'red', width: 2, dash: 'dash' }
            };
            
            const data = [actualTrace, idealTrace];

            const layout = {
                title: {
                    text: 'Predicted vs Actual Arrival Time (Test Data)',
                    font: { size: 16, color: '#4b5563' }
                },
                xaxis: { title: 'Actual Arrival Time (minutes)' },
                yaxis: { title: 'Predicted Arrival Time (minutes)' },
                margin: { t: 40, b: 40, l: 40, r: 40 },
                hovermode: 'closest',
                responsive: true
            };

            Plotly.newPlot('plotArea', data, layout, {responsive: true});
        }


        // --- Main Logic ---
        const uploadForm = document.getElementById('uploadForm');
        const trainForm = document.getElementById('trainForm');
        const predictForm = document.getElementById('predictForm');
        const downloadBtn = document.getElementById('downloadBtn');
        let isDataUploaded = false; // Track upload state

        // Helper function to show/hide loading spinners
        function toggleLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            const textSpan = document.getElementById(btnId.replace('Btn', 'Text'));
            const spinner = document.getElementById(btnId.replace('Btn', 'Spinner'));
            
            if (isLoading) {
                textSpan.classList.add('hidden');
                spinner.classList.remove('hidden');
                btn.disabled = true;
            } else {
                textSpan.classList.remove('hidden');
                spinner.classList.add('hidden');
                btn.disabled = false;
            }
        }

        // --- 1. Upload Handler (/upload) ---
        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            toggleLoading('uploadBtn', true);
            
            const fileInput = document.getElementById('csvFile');
            if (fileInput.files.length === 0) {
                showMessage('Please select a CSV file.');
                toggleLoading('uploadBtn', false);
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                const statusDiv = document.getElementById('uploadStatus');
                
                if (data.success) {
                    isDataUploaded = true;
                    statusDiv.textContent = `Data uploaded: ${data.rows} rows, ${data.columns.length} columns. Ready to train.`;
                    statusDiv.classList.remove('hidden');
                    showMessage('Data upload successful. Proceed to step 2.');
                } else {
                    statusDiv.classList.add('hidden');
                    showMessage('Upload Error: ' + data.error);
                }
            } catch (error) {
                showMessage('Network Error during Upload: ' + error.message);
            } finally {
                toggleLoading('uploadBtn', false);
            }
        });

        // --- 2. Train Handler (/train) ---
        trainForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!isDataUploaded) {
                showMessage('Please upload data first (Step 1).');
                return;
            }
            
            toggleLoading('trainBtn', true);

            try {
                const payload = {
                    model_type: document.getElementById('modelType').value,
                    train_split: parseFloat(document.getElementById('trainSplit').value)
                };

                const response = await fetch('/train', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('metricMAE').textContent = data.metrics.mae;
                    document.getElementById('metricRMSE').textContent = data.metrics.rmse;
                    document.getElementById('metricR2').textContent = data.metrics.r2;
                    document.getElementById('metricsArea').classList.remove('hidden');
                    showMessage('Model trained successfully! Metrics and plot updated.');
                    
                    // Plot the results using Plotly
                    plotResults(data.actual, data.predictions);

                } else {
                    showMessage('Training Error: ' + data.error);
                }
            } catch (error) {
                showMessage('Network Error during Training: ' + error.message);
            } finally {
                toggleLoading('trainBtn', false);
            }
        });

        // --- 3. Prediction Handler (/predict) ---
        predictForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            toggleLoading('predictBtn', true);

            try {
                // Ensure all four features are sent
                const payload = {
                    hour: parseFloat(document.getElementById('inputHour').value),
                    weekday: parseFloat(document.getElementById('inputWeekday').value),
                    scheduled: parseFloat(document.getElementById('inputScheduled').value),
                    passenger_count: parseFloat(document.getElementById('inputPassengerCount').value) 
                };
                
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                const resultDiv = document.getElementById('predictionResult');
                if (data.success) {
                    resultDiv.classList.remove('hidden');
                    resultDiv.innerHTML = `
                        <p class="text-xl font-bold">Predicted Arrival Time: <span class="text-blue-700">${data.prediction} minutes</span></p>
                        <small>Input: Hour=${payload.hour}, Weekday=${payload.weekday}, Scheduled=${payload.scheduled}, Passengers=${payload.passenger_count}</small>
                    `;
                } else {
                    showMessage('Prediction Error: ' + data.error);
                    resultDiv.classList.add('hidden');
                }
            } catch (error) {
                showMessage('Network Error during Prediction: ' + error.message);
            } finally {
                toggleLoading('predictBtn', false);
            }
        });

        // --- Download Handler ---
        downloadBtn.addEventListener('click', function() {
            window.location.href = '/download_csv';
        });

    </script>
</body>
</html>
